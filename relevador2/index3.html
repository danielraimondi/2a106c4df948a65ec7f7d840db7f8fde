<!doctype html>
<head>

<!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css" type="text/css" media="screen">  
<link rel="stylesheet" href="css/tablas.css" type="text/css" media="screen"> -->

<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<!-- <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>  -->


<script>

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}

$(document).ready(function() {

			var productos=[];
			
			$.ajax({
				url: "https://test-danielraimondi.c9.io/relevando/api/web/v1/route/clientes",
				type: 'GET',

				success: function(result) {

					var combo = document.getElementById('selectCliente'),
						temp = '';
						
					for (var c in result){
						temp += "<option value='"+result[c].client_id+"'>"+result[c].client_name+"</option>";	
					}
					combo.innerHTML += temp;
					
				 },

				error: function (request, status, error) {
					alert("No se puede conectar con el servidor...");
				}
			});

            $.ajax({
                url: "https://test-danielraimondi.c9.io/relevando/api/web/v1/product/ver?_format=json",
                type: 'GET',
                
                success: function(result) {
                    
                    
                    var divTabla= document.getElementById('tablaPedidos'),
                    	temp = '',
                    	dataTemp;

                    temp +="<thead><tr><th>ID</th><th>Producto</th><th>Stock</th><th>Pedir</th></tr></thead><tbody>";
                    
                    for (var i=0, tam=result.data.length; i< tam; i++){
                    	dataTemp = result.data[i];
                    	productos.push(dataTemp[0]);
                    	temp += "<tr><td id='id"+dataTemp[0]+"'>"+dataTemp[0]+"</td><td>"+dataTemp[1]+"</td><td><input value=0 id='stock"+dataTemp[0]+"'></td><td><input value=0 id='order"+dataTemp[0]+"'></td></tr>";	
                    }
                    temp += "</tbody></form>";
                    divTabla.innerHTML = temp;
                }, 
                error: function (request, status, error) {
		        alert("No se puede conectar con el servidor...");
		    	}
            });

			$(formulario).on('submit', function(e) {
				
				var fechaCompleta = new Date();
				var	fecha = fechaCompleta.getFullYear()+'-'+(fechaCompleta.getMonth()+1)+'-'+fechaCompleta.getDate();
				var	idCliente = document.getElementById('selectCliente').value;
				console.log(productos);
				
				for (var p in productos){
                    	
            	       	$.ajax({
			                url: "https://test-danielraimondi.c9.io/relevando/api/web/v1/survey",
			                type: 'POST',
			                dataType: 'json',
			                data: {
			                	survey_date: fecha,
			                	client_id: idCliente,
			                	user_id: 15,  //harcodeado
			                	prod_id: (document.getElementById("id"+productos[p]).innerHTML),
			                	stock: (document.getElementById("stock"+productos[p]).value),
			                	order: (document.getElementById("order"+productos[p]).value)
			                },
			                
			                success: function(result) {
			                	console.log("OK");
			                }
			                
                    	}); //ajax
                    	
                    	sleep(200);

				}; // for
			
			});


});

</script>

</head>

<body>



<div id='tabla'>
	<form id='formulario'>
		<label for='selectCliente'>Cliente:</label>
		<select id="selectCliente"></select>
		<table id='tablaPedidos' class='' cellspacing='0' width='50%'></table>
		<input type="submit" name="submit"/>
	</form>
</div>


</body>

